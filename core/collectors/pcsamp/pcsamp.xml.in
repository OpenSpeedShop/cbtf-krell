<?xml version="1.0" encoding="utf-8"?>

<!--
Copyright (c) 2011 Krell Institute. All Rights Reserved.
    
This library is free software; you can redistribute it and/or modify it under
the terms of the GNU Lesser General Public License as published by the Free
Software Foundation; either version 2.1 of the License, or (at your option)
any later version.
    
This library is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
details.
    
You should have received a copy of the GNU Lesser General Public License
along with this library; if not, write to the Free Software Foundation, Inc.,
59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-->

<MRNet xmlns="http://www.krellinst.org/CBTF/MRNet.xsd">

  <Type>pcsamp</Type>
  <Version>1.0.0</Version>

  <Stream>
    <Name>CBTF_PROTOCOL_TAG_ATTACHED_TO_THREADS</Name>
    <Tag>1101</Tag>
  </Stream>
  <Stream>
    <Name>CBTF_PROTOCOL_TAG_CREATED_PROCESS</Name>
    <Tag>1104</Tag>
  </Stream>
  <Stream>
    <Name>CBTF_PROTOCOL_TAG_LOADED_LINKED_OBJECT</Name>
    <Tag>1116</Tag>
  </Stream>
  <Stream>
    <Name>CBTF_PROTOCOL_TAG_UNLOADED_LINKED_OBJECT</Name>
    <Tag>1126</Tag>
  </Stream>
  <Stream>
    <Name>CBTF_PROTOCOL_TAG_LINKED_OBJECT_GROUP</Name>
    <Tag>1128</Tag>
  </Stream>
  <Stream>
    <Name>CBTF_PROTOCOL_TAG_PERFORMANCE_DATA</Name>
    <Tag>10000</Tag>
  </Stream>
  <Stream>
    <Name>CBTF_PROTOCOL_TAG_THREADS_STATE_CHANGED</Name>
    <Tag>1124</Tag>
  </Stream>

  <Output>
      <Name>output</Name>
      <From><Output>output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>created_process_xdr_output</Name>
      <From><Output>created_process_xdr_output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>attached_to_threads_xdr_output</Name>
      <From><Output>attached_threads_xdr_output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>threads_state_changed_xdr_output</Name>
      <From><Output>threads_state_changed_xdr_output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>loaded_linkedobject_xdr_output</Name>
      <From><Output>loaded_linkedobject_xdr_output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>unloaded_linkedobject_xdr_output</Name>
      <From><Output>unloaded_linkedobject_xdr_output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>linkedobjectgroup_xdr_output</Name>
      <From><Output>linkedobjectgroup_xdr_output_from_frontend</Output></From>
  </Output>

<!--
-->
  <Output>
      <Name>perfdata_xdr_output</Name>
      <From><Output>perfdata_xdr_output_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>addressbuffer_output</Name>
      <From><Output>addressbuffer_from_frontend</Output></From>
  </Output>

  <Output>
      <Name>linkedobjectentryvec_output</Name>
      <From><Output>linkedobjectentryvec_from_frontend</Output></From>
  </Output>
 
  <Frontend>

<!--
    <Network xmlns="http://www.krellinst.org/CBTF/Network">
-->
    <Network>
      <Type>pcsamp_Frontend</Type>
      <Version>1.0.0</Version>

      <SearchPath>@@component_location@@</SearchPath>

      <Plugin>CollectionPlugin.so</Plugin>

<!--
-->
      <Component>
        <Name>Aggregator</Name>
        <Type>AddressAggregator</Type>
      </Component>

      <Component>
        <Name>Display</Name>
        <Type>DisplayAddressBuffer</Type>
      </Component>

      <Component>
        <Name>LinkedObject</Name>
        <Type>LinkedObject</Type>
      </Component>

      <Component>
        <Name>ResolveSymbols</Name>
        <Type>ResolveSymbols</Type>
      </Component>

      <Component>
        <Name>ThreadsStateChanged</Name>
        <Type>ThreadsStateChanged</Type>
      </Component>

      <Component>
        <Name>AttachedToThreads</Name>
        <Type>AttachedToThreads</Type>
      </Component>

      <Component>
        <Name>CreatedProcess</Name>
        <Type>CreatedProcess</Type>
      </Component>
 
<!--
-->
      <Input>
        <Name>IncomingBlobs</Name>
        <To>
          <Name>Aggregator</Name>
          <Input>pass_cbtf_protocol_blob</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingBuffers</Name>
        <To>
          <Name>Aggregator</Name>
          <Input>addressBuffer</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingInterval</Name>
        <To>
          <Name>Display</Name>
          <Input>interval</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingLoadedLinkedObject</Name>
        <To>
          <Name>LinkedObject</Name>
          <Input>loaded</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingLinkedObjectGroup</Name>
        <To>
          <Name>LinkedObject</Name>
          <Input>group</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingThreadsStateChanged</Name>
        <To>
          <Name>ThreadsStateChanged</Name>
          <Input>in</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingAttachedToThreads</Name>
        <To>
          <Name>AttachedToThreads</Name>
          <Input>in</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingCreatedProcess</Name>
        <To>
          <Name>CreatedProcess</Name>
          <Input>in</Input>
        </To>
      </Input>

      <Connection>
        <From>
            <Name>AttachedToThreads</Name>
            <Output>out</Output>
        </From>
        <To>
            <Name>Aggregator</Name>
            <Input>threadnames</Input>
        </To>
      </Connection>

      <Connection>
        <From>
            <Name>AttachedToThreads</Name>
            <Output>out</Output>
        </From>
        <To>
            <Name>LinkedObject</Name>
            <Input>threadnames</Input>
        </To>
      </Connection>

      <Output>
         <Name>output_from_frontend</Name>
         <From>
            <Name>ThreadsStateChanged</Name>
            <Output>out1</Output>
         </From>
      </Output>

      <Output>
         <Name>created_process_xdr_output_from_frontend</Name>
         <From>
            <Name>CreatedProcess</Name>
            <Output>xdr_out</Output>
         </From>
      </Output>

      <Output>
         <Name>attached_threads_xdr_output_from_frontend</Name>
         <From>
            <Name>AttachedToThreads</Name>
            <Output>xdr_out</Output>
         </From>
      </Output>

      <Output>
         <Name>threads_state_changed_xdr_output_from_frontend</Name>
         <From>
            <Name>ThreadsStateChanged</Name>
            <Output>xdr_out</Output>
         </From>
      </Output>

      <Output>
         <Name>loaded_linkedobject_xdr_output_from_frontend</Name>
         <From>
            <Name>LinkedObject</Name>
            <Output>loaded_xdr_out</Output>
         </From>
      </Output>

      <Output>
         <Name>unloaded_linkedobject_xdr_output_from_frontend</Name>
         <From>
            <Name>LinkedObject</Name>
            <Output>unloaded_xdr_out</Output>
         </From>
      </Output>

      <Output>
         <Name>linkedobjectgroup_xdr_output_from_frontend</Name>
         <From>
            <Name>LinkedObject</Name>
            <Output>group_xdr_out</Output>
         </From>
      </Output>

<!--
-->
      <Output>
        <Name>perfdata_xdr_output_from_frontend</Name>
        <From>
          <Name>Aggregator</Name>
          <Output>datablob_xdr_out</Output>
        </From>
      </Output>

      <Output>
        <Name>addressbuffer_from_frontend</Name>
        <From>
          <Name>Aggregator</Name>
          <Output>Aggregatorout</Output>
        </From>
      </Output>

      <Output>
        <Name>linkedobjectentryvec_from_frontend</Name>
        <From>
          <Name>LinkedObject</Name>
          <Output>linkedobjectvec_out</Output>
        </From>
      </Output>

    </Network>

    <IncomingUpstream>
      <Name>Interval</Name>
      <To><Input>IncomingInterval</Input></To>
    </IncomingUpstream>
    <IncomingUpstream>
      <Name>Buffers</Name>
      <To><Input>IncomingBuffers</Input></To>
    </IncomingUpstream>
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_LOADED_LINKED_OBJECT</Name>
      <To><Input>IncomingLoadedLinkedObject</Input></To>
    </IncomingUpstream>
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_LINKED_OBJECT_GROUP</Name>
      <To><Input>IncomingLinkedObjectGroup</Input></To>
    </IncomingUpstream>
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_THREADS_STATE_CHANGED</Name>
      <To><Input>IncomingThreadsStateChanged</Input></To>
    </IncomingUpstream>
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_ATTACHED_TO_THREADS</Name>
      <To><Input>IncomingAttachedToThreads</Input></To>
    </IncomingUpstream>
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_CREATED_PROCESS</Name>
      <To><Input>IncomingCreatedProcess</Input></To>
    </IncomingUpstream>

<!--
-->
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_PERFORMANCE_DATA</Name>
      <To><Input>IncomingBlobs</Input></To>
    </IncomingUpstream>
 
  </Frontend>

<!--
     This filter is intended to run on the Leaf CP nodes only.
-->
  <Filter>
 
    <Depth>
	<LeafRelative>
	    <Offset>1</Offset>
	</LeafRelative>
    </Depth>

    <FilterMode>
	<WaitForAll/>
    </FilterMode>

    <Network xmlns="http://www.krellinst.org/CBTF/Network">
      <Type>pcsamp_Filter</Type>
      <Version>1.0.0</Version>

      <SearchPath>@@component_location@@</SearchPath>

      <Plugin>CollectionPlugin.so</Plugin>

      <Component>
        <Name>Aggregator</Name>
        <Type>AddressAggregator</Type>
      </Component>

      <Input>
        <Name>IncomingBlobs</Name>
        <To>
          <Name>Aggregator</Name>
          <Input>cbtf_protocol_blob</Input>
        </To>
      </Input>

      <Input>
        <Name>IncomingBuffers</Name>
        <To>
          <Name>Aggregator</Name>
          <Input>addressBuffer</Input>
        </To>
      </Input>
 
      <Output>
        <Name>OutgoingBuffers</Name>
        <From>
          <Name>Aggregator</Name>
          <Output>Aggregatorout</Output>
        </From>
      </Output>

      <Output>
        <Name>OutgoingInterval</Name>
        <From>
          <Name>Aggregator</Name>
          <Output>interval</Output>
        </From>
      </Output>

<!--
-->
      <Output>
        <Name>OutgoingBlobs</Name>
        <From>
          <Name>Aggregator</Name>
          <Output>datablob_xdr_out</Output>
        </From>
      </Output>
 
    </Network>    

<!--
-->
    <IncomingUpstream>
      <Name>CBTF_PROTOCOL_TAG_PERFORMANCE_DATA</Name>
      <To><Input>IncomingBlobs</Input></To>
    </IncomingUpstream>

    <IncomingUpstream>
      <Name>Buffers</Name>
      <To><Input>IncomingBuffers</Input></To>
    </IncomingUpstream>

    <OutgoingUpstream>
      <Name>Buffers</Name>
      <From><Output>OutgoingBuffers</Output></From>
    </OutgoingUpstream>

    <OutgoingUpstream>
      <Name>Interval</Name>
      <From><Output>OutgoingInterval</Output></From>
    </OutgoingUpstream>

<!--
-->
    <OutgoingUpstream>
      <Name>CBTF_PROTOCOL_TAG_PERFORMANCE_DATA</Name>
      <From><Output>OutgoingBlobs</Output></From>
    </OutgoingUpstream>

  </Filter>

</MRNet>
